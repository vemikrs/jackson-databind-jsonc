---
name: Release

"on":
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: false
        type: string
      skip_maven_central:
        description: 'Skip Maven Central publishing (GitHub release only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  deployments: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Release Artifacts
    outputs:
      version: ${{ steps.version.outputs.version }}
      publish_version: ${{ steps.version.outputs.publish_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            TAG_VERSION="${{ github.event.inputs.version }}"
          else
            TAG_VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Strip leading 'v' from tag for artifact/POM version
          PUBLISH_VERSION="${TAG_VERSION#v}"
          echo "version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "publish_version=${PUBLISH_VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${TAG_VERSION} (publish version: ${PUBLISH_VERSION})"

      - name: Build and sign artifacts
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          SIGNING_SECRET_KEY: ${{ secrets.SIGNING_SECRET_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          export PROJECT_VERSION="${{ steps.version.outputs.publish_version }}"
          ./gradlew clean build fatJar publishToMavenLocal -Pversion="$PROJECT_VERSION"
          
      - name: List built artifacts
        run: |
          echo "Built artifacts:"
          find lib/build/libs -name "*.jar" -ls
          echo ""
          echo "Maven repository artifacts:"
          find ~/.m2/repository/jp/vemi -name "*.jar" -ls 2>/dev/null || echo "No local Maven artifacts found"
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: release-artifacts
          path: |
            lib/build/libs/*.jar
            ~/.m2/repository/jp/vemi/**/*
          retention-days: 5

  github-release:
    needs: build
    runs-on: ubuntu-latest
    name: Create GitHub Release

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: release-artifacts
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          files: |
            artifacts/lib/build/libs/*.jar
          generate_release_notes: true
          body: |
            ## üì¶ Artifacts
            
            - **Slim JAR** (recommended): `jackson-databind-jsonc-${{ needs.build.outputs.publish_version }}.jar`
            - **Fat JAR** (all-in-one): `jackson-databind-jsonc-${{ needs.build.outputs.publish_version }}-all.jar`
            - **Sources JAR**: `jackson-databind-jsonc-${{ needs.build.outputs.publish_version }}-sources.jar`
            - **Javadoc JAR**: `jackson-databind-jsonc-${{ needs.build.outputs.publish_version }}-javadoc.jar`
            
            ## üöÄ Maven Central
            
            This release is automatically published to Maven Central via Central Portal.
            Status: https://central.sonatype.com/
            
            **Gradle:**
            ```kotlin
            implementation("jp.vemi:jackson-databind-jsonc:${{ needs.build.outputs.publish_version }}")
            ```
            
            **Maven:**
            ```xml
            <dependency>
              <groupId>jp.vemi</groupId>
              <artifactId>jackson-databind-jsonc</artifactId>
              <version>${{ needs.build.outputs.publish_version }}</version>
            </dependency>
            ```

  maven-central-publish:
    needs: [build, github-release]
    runs-on: ubuntu-latest
    name: Publish to Maven Central via Central Portal
    if: ${{ !github.event.inputs.skip_maven_central }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Set execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Publish to Maven Central via Central Portal
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: |
          # Check for publishing credentials (Central Portal required)
          if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ] || [ -z "$ORG_GRADLE_PROJECT_mavenCentralPassword" ]; then
            echo "üö® Missing Central Portal publishing credentials"
            echo "Please set the following GitHub Secrets:"
            echo "  ‚Ä¢ MAVEN_CENTRAL_USERNAME (Central Portal token name/ID)"
            echo "  ‚Ä¢ MAVEN_CENTRAL_PASSWORD (Central Portal token secret)"
            echo ""
            echo "üìö Setup guide: https://central.sonatype.com/"
            echo ""
            echo "üìã Manual upload instructions (fallback):"
            echo "1. Visit: https://central.sonatype.com/"
            echo "2. Sign in with your Central Portal account"
            echo "3. Upload artifacts from the GitHub release"
            echo "4. Follow the Central Portal publishing workflow"
            exit 1
          fi
          
          echo "üì¶ Publishing to Maven Central via Central Portal..."
          echo "Using Central Portal credentials"
          
          # Validate configuration
          export PROJECT_VERSION="${{ needs.build.outputs.publish_version }}"
          ./gradlew validateCredentials -Pversion="$PROJECT_VERSION"
          echo ""
          
          # Publish to Central Portal using Vanniktech Maven Publish plugin
          ./gradlew publishAllPublicationsToMavenCentralRepository -Pversion="$PROJECT_VERSION" --info -S
          
          echo ""
          echo "‚úÖ Published to Central Portal"
          echo "üîÑ Artifacts are being processed..."

      - name: Publishing Success
        if: success()
        run: |
          echo "‚úÖ Successfully published to Maven Central via Central Portal!"
          echo "üîç Check deployment status: https://central.sonatype.com/"
          echo "‚è±Ô∏è  Artifacts will appear on Maven Central once processing completes"
